<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Image Generator</title>
    <link rel="stylesheet" href="./css/stable-diffusion.css">
    <script src="./dist/tvmjs_runtime.wasi.js"></script>
    <script src="./dist/tvmjs.bundle.js"></script>
</head>

<body>
    <div class="container">
        <h1>Simple Image Generator with WebGPU</h1>

        <section class="section">
            <div class="input-container">
                <div class="form-group">
                    <label for="inputPrompt">Input prompt:</label>
                    <input name="inputPrompt" id="inputPrompt" type="text"
                        value="A photo of an astronaut riding a horse on mars" />
                </div>

                <div class="form-group">
                    <label for="negativePrompt">Negative prompt (optional):</label>
                    <input name="negativePrompt" id="negativePrompt" type="text" value="" />
                </div>

                <div class="form-group">
                    <label for="schedulerId">Select scheduler:</label>
                    <select name="scheduler" id="schedulerId">
                        <option value="0">Multi-step DPM Solver (20 steps)</option>
                        <option value="1">PNDM (50 steps)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="vaeCycle">Render intermediate steps:</label>
                    <select name="vae-cycle" id="vaeCycle">
                        <option value="-1">No</option>
                        <option value="2">Run VAE every two UNet steps after step 10</option>
                    </select>
                </div>

                <button id="generate-btn" onclick="tvmjsGlobalEnv.asyncOnGenerate()">Generate</button>
            </div>
        </section>

        <section class="section">
            <div id="progress">
                <label id="gpu-tracker-label"></label>
                <label id="progress-tracker-label"></label>
                <progress id="progress-tracker-progress" max="100" value="100"></progress>
            </div>
            <canvas id="canvas" width="512" height="512"></canvas>
            <div id="log"></div>
        </section>
    </div>

    <script>
        var tvmjsGlobalEnv = tvmjsGlobalEnv || {};
    </script>

    <script type="module">
        import init, { TokenizerWasm } from "./dist/tokenizers-wasm/tokenizers_wasm.js";

        var initialized = false;
        async function getTokenizer(name) {
            if (!initialized) {
                await init();
            }
            const jsonText = await (await fetch("https://huggingface.co/" + name + "/raw/main/tokenizer.json")).text();
            return new TokenizerWasm(jsonText);
        }

        tvmjsGlobalEnv.getTokenizer = getTokenizer;
    </script>

    <script src="./dist/stable_diffusion.js"></script>
    <script type="text/javascript" src="./dist/srcset-polyfill.js"></script>
</body>

</html>